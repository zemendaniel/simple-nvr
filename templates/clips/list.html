{% extends "base.html" %}

{% block head %}
    <style>
    .selected-clip {
        font-weight: bold;
        text-decoration: underline;
        color: red;
    }
    </style>
{% endblock %}


{% block main %}
<h1>Clips</h1>

<form method="get" class="mb-4 text-center" id="search-form">
    <input type="hidden" name="search" value="1">

    <label class="mx-2">
        <input type="checkbox" name="saved"
            {% if request.args.get('saved') %}checked{% endif %}>
        Saved Videos
    </label>

    <label class="mx-2">
        From:
    <input type="datetime-local" name="from_datetime" value="{{ request.args.get('from_datetime', '') }}">
    </label>

    <label class="mx-2">
        To:
    <input type="datetime-local" name="to_datetime" value="{{ request.args.get('to_datetime', '') }}">
    </label>

    <button type="submit" class="btn btn-primary mx-2">Filter</button>
    <button type="button" class="btn btn-secondary mx-2" onclick="clearFilters()">Reset</button>
</form>

<div class="mb-4 text-center">
    {% for cam in cams %}
        <a href="{{ url_for('clips.list_all') }}?cam={{ cam.id }}" class="mx-2">
            {{ cam.name }}
        </a>
    {% endfor %}
</div>

{% if clips %}
<div id="timeline" class="mb-4 text-center">
    <p>Click a timestamp to load video:</p>
    <form id="clips-action-form" method="post" action="{{ url_for('clips.action') }}?saved={{ saved if saved }}&cam_id={{ cam_id }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        {% for clip in clips %}
        <div style="display: inline-block; margin: 0 10px; text-align: center;">
            <input type="checkbox" name="selected_clips" value="{{ clip.name }}" id="clip-{{ loop.index }}">
            <label for="clip-{{ loop.index }}">
                <button
                    type="button"
                    class="btn btn-link clip-time"
                    onclick="selectVideo('{{ clip.modified.strftime('%Y-%m-%d %H:%M:%S') }}', '{{ url_for('clips.play', filename=clip.name) }}?saved={{ saved if saved }}&cam_id={{ cam_id }}', this)">
                    {{ clip.modified.strftime('%Y-%m-%d %H:%M:%S') }}
                </button>
            </label>
        </div>
        {% endfor %}

        <div style="margin-top: 20px;">
            <button type="submit" name="action" value="delete" class="btn btn-danger" onclick="return confirm('Delete selected clips?');">Delete Selected</button>
            {% if not saved %}
                <button type="submit" name="action" value="save" class="btn btn-success ms-2" onclick="return confirm('Save selected clips?');">Save Selected</button>
            {% endif %}
        </div>
    </form>
</div>

    <div id="video-container" class="text-center"></div>

{% else %}
    <p class="text-center mt-4">There are no clips.</p>
{% endif %}

<script>
let lastSelectedButton = null;


function clearFilters() {
  const form = document.getElementById('search-form');
  form.reset();

  // Also manually clear datetime values (in case browser retains them)
  form.querySelector('[name="from_datetime"]').value = '';
  form.querySelector('[name="to_datetime"]').value = '';
  form.querySelector('[name="saved"]').checked = false;
  form.submit();
}

function selectVideo(time, src, button) {
    if (lastSelectedButton) {
    lastSelectedButton.classList.remove('selected-clip');
    }
    button.classList.add('selected-clip')
    lastSelectedButton = button


      const videoContainer = document.getElementById('video-container');

      // Clear any existing video
      videoContainer.innerHTML = '';

      // Create video element
      const video = document.createElement('video');
      video.setAttribute('width', '640');
      video.setAttribute('height', '360');
      video.setAttribute('controls', '');
      video.setAttribute('preload', 'metadata');

      const source = document.createElement('source');
      source.setAttribute('src', src);
      source.setAttribute('type', 'video/mp4');

      video.appendChild(source);

      // Add time label above video
      const timeLabel = document.createElement('p');
      timeLabel.className = 'text-muted';
      timeLabel.textContent = time;

      videoContainer.appendChild(timeLabel);
      videoContainer.appendChild(video);

      // Scroll to video
      video.scrollIntoView({ behavior: 'smooth' });
      video.play();

}

</script>

{% endblock %}
